% lt_bib.sty
% Sam Harrison 2018
% MIT License: a full version of the license is included in the LICENSE file.

% For TeXShop, TeXWorks, etc
% !TEX encoding = UTF-8 Unicode
% !TEX spellcheck = en-GB

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Package info {{{

% Requires at least LaTeX version 2e.
\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{lt_bib}[2018/09/10 Bibliography formatting]

% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Load biblatex {{{

% General comments:
%  + Prefer a more verbose citestyle as, IMHO, it makes it easier to identify
%    specific references in the text.
%  + Makes sense to make use of \autocite{}, with \textcite{} where needed.
%  + The sort order for the bibliography itself (not the in-text citations) is
%    set using a second ref context. Use:
%    \newrefcontext[sorting=nyt]
%    \printbibliography
%  + Can add e.g. "In press" articles to bibliography using the pubstate field
%    pubstate = {inpress}

\RequirePackage[
        backend=biber,
        % Use author and year for citations
        % texdoc authoryear-icomp
        bibstyle=authoryear,
        citestyle=authoryear-icomp, % Use ibid; compress same author list
        % Name format
        giveninits=true,    % Just print initials rather than first names
        % Bibliography format
        dashed=true,        % Recurring author lists replaced by dash
        mergedate=basic,    % Only print date again at end if provides more info
        maxbibnames=5,      % Max no. of authors to print in bibliography
        minbibnames=5,      % If we do truncate, print 5 authors and et al.
        % Citation format
        sortcites=true,     % i.e. sort \cite{B,A,C} => A,B,C
        sorting=ynt,        % Year, Name, Title
        maxcitenames=2,     % Maximum of 2 authors in text
        mincitenames=1,     % But just "Author et al." for truncated citations
        uniquelist=false,   % 2015a as necessary rather than adding authors
        uniquename=mininit  % Use author initials to disambiguate entries (but as sparingly as possible)
    ]{biblatex}

% Change so all names in the bibliography are last-first (otherwise prints
% first author last-first, and rest first-last...)
% https://tex.stackexchange.com/a/13076
\DeclareNameAlias{sortname}{family-given}

% Clear things we don't want to be printed
\ExecuteBibliographyOptions{
        isbn=false,
        url=false,
        doi=false,
        eprint=false
    }
\AtEveryBibitem{\clearfield{note}}

% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tweak formatting {{{

% Make the titles in the bibliography be hyperlinks to the specified URL / DOI
% http://tex.stackexchange.com/questions/23832/biblatex-make-title-hyperlink-to-doi-url-if-available
% http://tex.stackexchange.com/questions/48400/biblatex-make-title-hyperlink-to-dois-url-or-isbn
% http://tex.stackexchange.com/questions/3039/bibliography-entry-containing
\newcommand{\href}[2]{#2}   % Do nothing in case hyperref not loaded

\newbibmacro{string+link}[1]{%
    \iffieldundef{doi}%
    {\iffieldundef{url}{#1}{\href{\thefield{url}}{#1}}}%
    {\href{http://dx.doi.org/\thefield{doi}}{#1}}}
\DeclareFieldFormat*{title}{\usebibmacro{string+link}{\mkbibemph{#1}}}

% Change \parencite citation to square brackets
% http://tex.stackexchange.com/questions/16765/biblatex-author-year-square-brackets
\newrobustcmd*{\parentexttrack}[1]{%
    \begingroup
    \blx@blxinit
    \blx@setsfcodes
    \blx@bibopenparen#1\blx@bibcloseparen
    \endgroup}

\AtEveryCite{%
    \let\parentext=\parentexttrack%
    \let\bibopenparen=\bibopenbracket%
    \let\bibcloseparen=\bibclosebracket}

% Change so whole citation is a link (except for \textcite)
% http://tex.stackexchange.com/questions/15951/hyperlink-name-with-biblatex-authoryear-biblatex-1-4b
\DeclareFieldFormat{citehyperref}{%
    \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
    \bibhyperref{#1}}

\savebibmacro{cite}

\renewbibmacro*{cite}{%
    \printtext[citehyperref]{%
        \restorebibmacro{cite}%
        \usebibmacro{cite}}}

% Compress citations by removing comma between entries
%\renewcommand*{\multicitedelim}{\addcomma}

%Make new command for a superscript citation that matches the \cite command
% In the numeric case this will have brackets (i.e. super-b-cite ...)
%\newcommand*{\superbcite}[1]{\textsuperscript{\cite{#1}}}

% }}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
